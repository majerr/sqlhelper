<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="sqlhelper">
<title>Using sqlhelper in packages • sqlhelper</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using sqlhelper in packages">
<meta property="og:description" content="sqlhelper">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">sqlhelper</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/sqlhelper.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/connections.html">Managing Connections</a>
    <a class="dropdown-item" href="../articles/execution.html">Executing SQL</a>
    <a class="dropdown-item" href="../articles/use_case.html">Using sqlhelper in packages</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/majerr/sqlhelper/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using sqlhelper in packages</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/majerr/sqlhelper/blob/HEAD/vignettes/use_case.Rmd" class="external-link"><code>vignettes/use_case.Rmd</code></a></small>
      <div class="d-none name"><code>use_case.Rmd</code></div>
    </div>

    
    
<p><code>sqlhelper</code> was written to streamline SQL integration in
packages designed to meet organizations’ particular analytical needs, in
stable data contexts. The pattern of integrating SQL with R code in
analysis packages is intended to:</p>
<ul>
<li>make use of the data-wrangling capacity of databases and SQL;</li>
<li>take advantage of R’s packaging system to write reliable,
understandable code;</li>
<li>keep all the code for a task in one place.</li>
</ul>
<p>This note describes how to use <code>sqlhelper</code> safely inside a
package.</p>
<div class="section level2">
<h2 id="connections">Connections<a class="anchor" aria-label="anchor" href="#connections"></a>
</h2>
<p>If more than one connection is needed for a project, the easiest
approach will be to define them in a yaml file as described in
<code><a href="../articles/connections.html">vignette("connections")</a></code>. The yaml file is placed under
<code>inst</code> in the root of the package and accessed with
<code>devtools::system.file()</code> (see <a href="https://r-pkgs.org/misc.html#sec-misc-inst" class="external-link">r-pkgs</a> on using
installed files).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sqlhelper</span><span class="fu">::</span><span class="fu"><a href="../reference/connect.html">connect</a></span><span class="op">(</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span> <span class="st">"sqlhelper_connection_conf.yml"</span> <span class="op">)</span>,</span>
<span>    exclusive<span class="op">=</span><span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Connections that cannot be defined this way may be defined within the
package. How this is handled will depend on considerations such as how
long each connection will be needed for, how widely it will need to be
shared between other package components, and whether it will need to be
exposed to users.</p>
<p>If a connection is needed once and may be used and closed during the
execution of a single function it may be sufficient to define it within
the namespace of that function and close it on or before the function
exits, for example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_some_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="va">a_driver</span>, <span class="st">"a connection string"</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">sqlhelper</span><span class="fu">::</span><span class="fu"><a href="../reference/run_files.html">run_files</a></span><span class="op">(</span> </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"SQL/my_sql_file.SQL"</span><span class="op">)</span>,</span>
<span>          default.conn <span class="op">=</span> <span class="va">conn</span></span>
<span>        <span class="op">)</span></span>
<span>    </span>
<span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></span>
<span>  <span class="va">d</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>A connection that needs to be shared across functions or function
calls, but not exposed to users, may be stored in an environment in the
package’s top-level namespace, for example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">"connection_store"</span>,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">new.env</span>(<span class="at">parent =</span> <span class="fu">emptyenv</span>()),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">environment</span>())</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>connect <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assign</span>(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"c1"</span>, </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    DBI<span class="sc">::</span><span class="fu">dbConnect</span>(a_driver, <span class="st">"a connection string"</span>), </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">envir =</span> connection_store</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>get_some_data <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  sqlhelper<span class="sc">::</span><span class="fu">run_files</span>( </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">system.file</span>(<span class="st">"SQL/my_sql_file.SQL"</span>),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">default.conn =</span> connection_store<span class="sc">$</span>c1</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a bit belt-and-braces, but thorough.</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>disconnect <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(connection_store<span class="sc">$</span>c1)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  connection_store<span class="sc">$</span>c1 <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list=</span><span class="fu">c</span>(<span class="st">"c1), envir=connection_store)</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span></code></pre></div>
<p>(this approach is in fact more or less the one take by
<code>sqlhelper</code> itself)</p>
</div>
<div class="section level2">
<h2 id="sql-files">SQL files<a class="anchor" aria-label="anchor" href="#sql-files"></a>
</h2>
<p>If multiple connections are required but cannot be defined in yaml it
will somewhat diminish the ability to control execution on a
query-by-query basis and may produce a need to split queries into more
files than would otherwise be necessary. mf a package contains many SQL
files, it may be useful to store them in a SQL directory under
<code>inst/</code>. They may be accessed in the same way, with
<code><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file()</a></code>, either
<code>system.file("SQL", "file_name.SQL")</code> or
<code>system.file("SQL/file_name.SQL")</code> (the latter <em>may</em>
be somewhat less portable).</p>
<p>It is often convenient to define SQL parameters in a different scope
to the calling scope of <code><a href="../reference/run_files.html">run_files()</a></code>. In this case it is
important to ensure that the package does not interfere with the user’s
global environment. The easiest way to do this is to store them in an
environment (e.g. in the same way as illustrated for connections, above)
and pass them to the <code>values</code> parameter of
<code><a href="../reference/run_files.html">run_files()</a></code>, <code><a href="../reference/run_queries.html">run_queries()</a></code> or
<code><a href="../reference/prepare_sql.html">prepare_sql()</a></code>. See <code><a href="../reference/run_queries.html">run_queries()</a></code> or
<code><a href="../articles/execution.html">vignette("execution")</a></code> for examples.</p>
</div>
<div class="section level2">
<h2 id="exit">Exit<a class="anchor" aria-label="anchor" href="#exit"></a>
</h2>
<p>It may be desirable to close <code>sqlhelper</code>’s connections
when a calling package has completed it’s operations. This can be
achieved easily with <code><a href="../reference/disconnect.html">sqlhelper::disconnect()</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matthew Roberts.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
