<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="sqlhelper">
<title>Executing SQL • sqlhelper</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Executing SQL">
<meta property="og:description" content="sqlhelper">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">sqlhelper</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/sqlhelper.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/connections.html">Managing Connections</a>
    <a class="dropdown-item" href="../articles/execution.html">Executing SQL</a>
    <a class="dropdown-item" href="../articles/use_case.html">Using sqlhelper in packages</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/majerr/sqlhelper/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Executing SQL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/majerr/sqlhelper/blob/HEAD/vignettes/execution.Rmd" class="external-link"><code>vignettes/execution.Rmd</code></a></small>
      <div class="d-none name"><code>execution.Rmd</code></div>
    </div>

    
    
<p><code>sqlhelper</code>’s main purpose is the execution of
<em>files</em> of SQL, with options for controlling the execution of
individual SQL queries within each file. The function
<code><a href="../reference/run_files.html">run_files()</a></code> executes .SQL files. Internally,
<code><a href="../reference/run_files.html">run_files()</a></code> calls the functions <code><a href="../reference/read_sql.html">read_sql()</a></code>,
<code><a href="../reference/prepare_sql.html">prepare_sql()</a></code> and <code><a href="../reference/run_queries.html">run_queries()</a></code> and these
functions can be used to read and prepare SQL files without executing
them, and to execute SQL query strings.</p>
<div class="section level2">
<h2 id="executing-sql-files">Executing SQL files<a class="anchor" aria-label="anchor" href="#executing-sql-files"></a>
</h2>
<p>Executing SQL code requires a connection to a database, and
<code>sqlhelper</code> provides ways to automate creating and managing
connections. These are described in
<code><a href="../articles/connections.html">vignette("connections")</a></code>.</p>
<p>Once connections are configured, the <code><a href="../reference/run_files.html">run_files()</a></code> command
can be used to execute files of SQL code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://majerr.github.io/sqlhelper/dev/">sqlhelper</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/connect.html">connect</a></span><span class="op">(</span><span class="st">"examples/sqlhelper_db_conf.yml"</span>, exclusive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span> <span class="fu"><a href="../reference/default_conn.html">default_conn</a></span><span class="op">(</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"IRIS"</span>, <span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"examples/example.sql"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; -- qname = how_many_irises</span></span>
<span><span class="co">#&gt; SELECT count(*) as N FROM IRIS;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- qname = short_petal_setosa</span></span>
<span><span class="co">#&gt; select Species, `Petal.Length`</span></span>
<span><span class="co">#&gt; FROM IRIS</span></span>
<span><span class="co">#&gt; WHERE Species = "setosa"</span></span>
<span><span class="co">#&gt; AND `Petal.Length` &lt; {petal_length}</span></span>
<span></span>
<span><span class="va">petal_length</span> <span class="op">&lt;-</span> <span class="fl">1.3</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_files.html">run_files</a></span><span class="op">(</span><span class="st">"examples/example.sql"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span></span>
<span><span class="co">#&gt; $how_many_irises</span></span>
<span><span class="co">#&gt;     N</span></span>
<span><span class="co">#&gt; 1 150</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $short_petal_setosa</span></span>
<span><span class="co">#&gt;   Species Petal.Length</span></span>
<span><span class="co">#&gt; 1  setosa          1.1</span></span>
<span><span class="co">#&gt; 2  setosa          1.2</span></span>
<span><span class="co">#&gt; 3  setosa          1.0</span></span>
<span><span class="co">#&gt; 4  setosa          1.2</span></span></code></pre></div>
<p>As well as individual file names, <code><a href="../reference/run_files.html">run_files()</a></code> accepts a
vector of file names.</p>
<div class="section level3">
<h3 id="accessing-results-of-queries">Accessing results of queries<a class="anchor" aria-label="anchor" href="#accessing-results-of-queries"></a>
</h3>
<p><code><a href="../reference/run_files.html">run_files()</a></code> returns a list of results of the same length
as the number of queries. In the above example, names are assigned to
queries with <em>interpreted comments</em>, of the form
<code>-- qname = my_query_name</code>. If queries are named, individual
results can be accessed by the same name:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span><span class="op">$</span><span class="va">short_petal_setosa</span></span>
<span><span class="co">#&gt;   Species Petal.Length</span></span>
<span><span class="co">#&gt; 1  setosa          1.1</span></span>
<span><span class="co">#&gt; 2  setosa          1.2</span></span>
<span><span class="co">#&gt; 3  setosa          1.0</span></span>
<span><span class="co">#&gt; 4  setosa          1.2</span></span></code></pre></div>
<p>Results returned as list may also be accessed by index, of course.
However, if a file contains a single query, the result of that query
will be returned as is, (i.e. an object, not a single element list).</p>
<p>Beware of the usual gotchas around list names. <code>sqlhelper</code>
will not complain if you give two queries the same name, but if you then
try to access the results by name, you will only get the result of the
first query with that name. This is particularly relevant if your
project executes queries from multiple files and those files are
developed by different people. Similarly, be careful not to use anything
in query names that that R will interpret as an operator or special
character. In the above example, naming the query
<code>short-petal-setosa</code> will cause an error because R will
interpret <code>-</code> as a subtraction.</p>
</div>
<div class="section level3">
<h3 id="controlling-execution-of-individual-queries">Controlling execution of individual queries<a class="anchor" aria-label="anchor" href="#controlling-execution-of-individual-queries"></a>
</h3>
<p>As well as naming queries, interpreted comments can be used to
control aspects of execution on a per-query basis. For example, queries
are executed with <code><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">DBI::dbGetQuery()</a></code> by default, but
<code>sqlite</code> will complain if you use this to send a statement to
the database. You can control the execution function with the
<code>execmethod</code> keyword:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- qname = bobby_tables</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- execmethod = sendq</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> Students;</span></code></pre></div>
<p>All interpreted comments follow the form
<code>-- &lt;keyword&gt; = &lt;value&gt;</code>.</p>
<p>Interpretable keywords are:</p>
<ul>
<li>
<strong>qname</strong> A name for this query</li>
<li>
<strong>interpolate</strong> “yes” or “no” - should this query be
parameterized?</li>
<li>
<strong>quotesql</strong> “yes” or “no” - should interpolated
characters be quoted?</li>
<li>
<strong>execmethod</strong> One of “get”, “execute”, “sendq”,
“sends” or “spatial” - which method should be used to execute the query?
“get” means <code><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">DBI::dbGetQuery()</a></code>; “execute” means
<code><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">DBI::dbExecute()</a></code>; “sendq” means
<code><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html" class="external-link">DBI::dbSendQuery()</a></code>; “sends” means
<code><a href="https://dbi.r-dbi.org/reference/dbSendStatement.html" class="external-link">DBI::dbSendStatement()</a></code>; “spatial” means
<code><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">sf::st_read()</a></code>.</li>
<li>
<strong>geometry</strong> The name of a spatial column. Ignored if
<code>execmethod</code> is not ‘spatial’</li>
<li>
<strong>conn_name</strong> The name of a connection to execute this
query against</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add combined standard/spatial example</span></span></code></pre></div>
<div class="section level4">
<h4 id="cascade">Cascaded execution parameters<a class="anchor" aria-label="anchor" href="#cascade"></a>
</h4>
<p>All interpreted comments except <code>qname</code> are cascaded
<em>within their file</em>, meaning that if you want to use the same
values throughout, you need only set them for the first query. See also
<code><a href="../reference/read_sql.html">read_sql()</a></code> for details.</p>
<p>If you want to change the execution parameters for the first query
only and retain the defaults for the remainder you will need to
either:</p>
<ul>
<li>use interpreted comments to explicitly reset the defaults for the
second query; or</li>
<li>put the second and subsequent queries in a different file.</li>
</ul>
<p>You can prevent cascading by passing
<code>cascade = FALSE</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## cascaded comments example</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="interpolation">Interpolation<a class="anchor" aria-label="anchor" href="#interpolation"></a>
</h3>
<p>By default, <code>sqlhelper</code> will attempt to parameterize SQL
queries with <code><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue::glue_sql()</a></code> using values from the current
environment. This means that values from R can be easily inserted in
your SQL code, or calculated in situ:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"examples/petal_length_params.sql"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; -- qname = short_petal_setosa</span></span>
<span><span class="co">#&gt; select Species, `Petal.Length`</span></span>
<span><span class="co">#&gt; FROM IRIS</span></span>
<span><span class="co">#&gt; WHERE Species = "setosa"</span></span>
<span><span class="co">#&gt; AND `Petal.Length` &lt; {petal_length};</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- qname = setosa_petal_1sd_below</span></span>
<span><span class="co">#&gt; select Species, `Petal.Length`</span></span>
<span><span class="co">#&gt; FROM IRIS</span></span>
<span><span class="co">#&gt; WHERE Species = "setosa"</span></span>
<span><span class="co">#&gt; AND `Petal.Length` &lt; {</span></span>
<span><span class="co">#&gt;   mean(iris$Petal.Length[iris$Species == "setosa"])</span></span>
<span><span class="co">#&gt;     -  sd(iris$Petal.Length[iris$Species == "setosa"])</span></span>
<span><span class="co">#&gt; }</span></span>
<span></span>
<span><span class="va">petal_length</span> <span class="op">=</span> <span class="fl">1.2</span></span>
<span></span>
<span><span class="fu"><a href="../reference/run_files.html">run_files</a></span><span class="op">(</span><span class="st">"examples/petal_length_params.sql"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $short_petal_setosa</span></span>
<span><span class="co">#&gt;   Species Petal.Length</span></span>
<span><span class="co">#&gt; 1  setosa          1.1</span></span>
<span><span class="co">#&gt; 2  setosa          1.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $setosa_petal_1sd_below</span></span>
<span><span class="co">#&gt;   Species Petal.Length</span></span>
<span><span class="co">#&gt; 1  setosa          1.1</span></span>
<span><span class="co">#&gt; 2  setosa          1.2</span></span>
<span><span class="co">#&gt; 3  setosa          1.0</span></span>
<span><span class="co">#&gt; 4  setosa          1.2</span></span></code></pre></div>
<p>Interpolation behaviour can be controlled using the keywords
<strong>interpolate</strong> and <strong>quotesql</strong>, and the
<code>values</code> parameter of <code><a href="../reference/prepare_sql.html">prepare_sql()</a></code> (which can
be also passed to <code><a href="../reference/run_files.html">run_files()</a></code> and
<code><a href="../reference/run_queries.html">run_queries()</a></code>).</p>
<p>The default behaviour is to quote SQL strings (i.e. interpolate with
<code><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue::glue_sql()</a></code>); if this is not desired it can be avoided
with <code>-- quotesql = no</code> (for an individual query in a file;
but see <a href="#cascade">the ‘cascaded comments’ example, above</a>)
or by passing <code>quotesql = "no"</code> as a parameter to
<code><a href="../reference/run_files.html">run_files()</a></code> (for all queries). If strings are not quoted
they will be inserted bare; whilst this is occasionally useful, great
care should be taken to sanitize any interpolated values.</p>
<p>If you want to skip interpolation for an individual query, precede it
with <code>-- interplate = no</code>. If you want to skip interpolation
altogether, pass <code>interpolate = "no"</code> as a parameter and see
also <a href="#cascade">the ‘cascaded comments’ example, above</a>.</p>
<div class="section level4">
<h4 id="values">Passing parameter values<a class="anchor" aria-label="anchor" href="#values"></a>
</h4>
<p>Sometimes you may need to parameterize your SQL with values that are
not in the calling environment. This is particularly important if your
are executing SQL code from within a package: you cannot rely on, and
should not risk writing to, your users’ <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">globalenv()</a></code>. To
supply interpolation values to <code><a href="../reference/run_files.html">run_files()</a></code> and
<code><a href="../reference/run_queries.html">run_queries()</a></code>, pass a populated environment as the
<code>values</code> parameter.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reusing the petal length parameter example</span></span>
<span><span class="co"># A user may have a petal_length parameter in the globalenv already</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">petal_length</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.2</span></span>
<span><span class="va">result_from_globalenv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/run_files.html">run_files</a></span><span class="op">(</span><span class="st">"examples/petal_length_params.sql"</span><span class="op">)</span></span>
<span><span class="va">result_from_globalenv</span><span class="op">$</span><span class="va">short_petal_setosa</span></span>
<span><span class="co">#&gt;   Species Petal.Length</span></span>
<span><span class="co">#&gt; 1  setosa          1.1</span></span>
<span><span class="co">#&gt; 2  setosa          1.0</span></span>
<span></span>
<span><span class="co"># a bespoke environment can provide a specific set of values for interpolation</span></span>
<span><span class="va">my_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">my_values</span><span class="op">$</span><span class="va">petal_length</span> <span class="op">&lt;-</span> <span class="fl">1.4</span></span>
<span><span class="va">result_from_my_values</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/run_files.html">run_files</a></span><span class="op">(</span><span class="st">"examples/petal_length_params.sql"</span>, values <span class="op">=</span> <span class="va">my_values</span><span class="op">)</span></span>
<span><span class="va">result_from_my_values</span><span class="op">$</span><span class="va">short_petal_setosa</span></span>
<span><span class="co">#&gt;    Species Petal.Length</span></span>
<span><span class="co">#&gt; 1   setosa          1.3</span></span>
<span><span class="co">#&gt; 2   setosa          1.1</span></span>
<span><span class="co">#&gt; 3   setosa          1.2</span></span>
<span><span class="co">#&gt; 4   setosa          1.3</span></span>
<span><span class="co">#&gt; 5   setosa          1.0</span></span>
<span><span class="co">#&gt; 6   setosa          1.2</span></span>
<span><span class="co">#&gt; 7   setosa          1.3</span></span>
<span><span class="co">#&gt; 8   setosa          1.3</span></span>
<span><span class="co">#&gt; 9   setosa          1.3</span></span>
<span><span class="co">#&gt; 10  setosa          1.3</span></span>
<span><span class="co">#&gt; 11  setosa          1.3</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="binding">Binding<a class="anchor" aria-label="anchor" href="#binding"></a>
</h3>
<p>Binding can be performed alongside interpolation. Queries and
statements are first interpolated and then should then be executed with
<code><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html" class="external-link">DBI::dbSendQuery()</a></code> or <code><a href="https://dbi.r-dbi.org/reference/dbSendStatement.html" class="external-link">DBI::dbSendStatement()</a></code>.
They may then be bound and the result fetched.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"examples/binding.SQL"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; -- execmethod = sendq</span></span>
<span><span class="co">#&gt; -- qname = binding_example</span></span>
<span><span class="co">#&gt; SELECT species, [Petal.Width]</span></span>
<span><span class="co">#&gt; FROM IRIS</span></span>
<span><span class="co">#&gt; WHERE SPECIES = ? AND</span></span>
<span><span class="co">#&gt; [Petal.Width] &lt; {petal_width};</span></span>
<span></span>
<span><span class="va">petal_width</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_files.html">run_files</a></span><span class="op">(</span><span class="st">"examples/binding.SQL"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbBind.html" class="external-link">dbBind</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">binding_example</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"setosa"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbFetch.html" class="external-link">dbFetch</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">binding_example</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Species Petal.Width</span></span>
<span><span class="co">#&gt; 1  setosa         0.1</span></span>
<span><span class="co">#&gt; 2  setosa         0.1</span></span>
<span><span class="co">#&gt; 3  setosa         0.1</span></span>
<span><span class="co">#&gt; 4  setosa         0.1</span></span>
<span><span class="co">#&gt; 5  setosa         0.1</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbClearResult.html" class="external-link">dbClearResult</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">binding_example</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="reading-and-preparing-sql-files">Reading and preparing SQL files<a class="anchor" aria-label="anchor" href="#reading-and-preparing-sql-files"></a>
</h2>
<p>SQL files and strings can be read and prepared without being executed
by the <code><a href="../reference/read_sql.html">read_sql()</a></code> and <code><a href="../reference/prepare_sql.html">prepare_sql()</a></code> functions.
These functions return tibbles containing the prepared SQL, associated
metadata (e.g. filename), and execution parameters. These functions
enable both inspection of prepared SQL and parameters for debugging, and
further manipulation of SQL queries prior to execution.</p>
</div>
<div class="section level2">
<h2 id="executing-sql-strings">Executing SQL strings<a class="anchor" aria-label="anchor" href="#executing-sql-strings"></a>
</h2>
<p>One of the main objectives of <code>sqlhelper</code> is to reduce the
incidence of SQL written as strings in R code. However, it is
occasionally convenient for interactive exploratory work to type a query
as a string. For this you may use <code><a href="../reference/run_queries.html">run_queries()</a></code>. This
function can also be used to execute queries that have been read from
files (e.g. with <code><a href="../reference/read_sql.html">read_sql()</a></code>) and then manipulated
programmatically before execution.</p>
</div>
<div class="section level2">
<h2 id="passing-ad-hoc-connections-to-functions">Passing ad-hoc connections to functions<a class="anchor" aria-label="anchor" href="#passing-ad-hoc-connections-to-functions"></a>
</h2>
<p>It may not always be possible or desirable to have
<code>sqlhelper</code> manage your database connections. For example,
the use of secrets is not yet supported in <code>sqlhelper</code>
connections. In these cases, connections created outside
<code>sqlhelper</code> may be passed to to <code><a href="../reference/run_files.html">run_files()</a></code> or
<code><a href="../reference/run_queries.html">run_queries()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cars</span> <span class="op">&lt;-</span> <span class="va">mtcars</span></span>
<span><span class="va">cars</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cars"</span>, <span class="va">cars</span><span class="op">)</span></span>
<span></span>
<span><span class="va">minmpg</span> <span class="op">=</span> <span class="fl">30</span></span>
<span></span>
<span><span class="fu"><a href="../reference/run_queries.html">run_queries</a></span><span class="op">(</span><span class="st">"SELECT model, mpg, cyl FROM CARS WHERE mpg &gt;= {minmpg}"</span>,</span>
<span>            default.conn <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt;            model  mpg cyl</span></span>
<span><span class="co">#&gt; 1       Fiat 128 32.4   4</span></span>
<span><span class="co">#&gt; 2    Honda Civic 30.4   4</span></span>
<span><span class="co">#&gt; 3 Toyota Corolla 33.9   4</span></span>
<span><span class="co">#&gt; 4   Lotus Europa 30.4   4</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matthew Roberts.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
